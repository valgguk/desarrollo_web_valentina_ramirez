<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Adopta Mascotas — Portada</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}">
</head>
<body>
<header>
  <div class="container">
    <h1>Adopta Mascotas</h1>
    <nav>
      <a href="{{ url_for('main.agregar') }}">Agregar aviso de adopción</a>
      <a href="{{ url_for('main.listado') }}">Ver listado de adopciones</a>
  <a href="{{ url_for('main.estadisticas') }}">Ver estadísticas</a>
      <a href="http://localhost:8080/evaluacion" target="_blank">Evaluación ⭐</a>
    </nav>
  </div>
</header>
<main class="container">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div id="flash-overlay" style="position:fixed; top:1rem; left:50%; transform:translateX(-50%); background:#222; color:#fff; padding:1rem 1.25rem; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,.35); z-index:1000; font-size:.95rem;">
        {% for cat, msg in messages %}
          <div><strong>{{ cat|capitalize }}:</strong> {{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  <section class="section">
    <h2>Bienvenido</h2>
    <p class="small">Aplicación de adopción de mascotas. Aquí ves los últimos 5 avisos ingresados.</p>
  </section>

  <section class="section" aria-labelledby="ultimos-heading">
    <h3 id="ultimos-heading">Últimos 5 avisos</h3>
    {% if avisos %}
  <table id="ultimos" class="tabla-listado">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Comuna</th>
          <th>Sector</th>
          <th>Cant / Tipo / Edad</th>
          <th>Foto</th>
          {# Columna Detalle eliminada: la fila completa es clickeable #}
        </tr>
      </thead>
      <tbody>
        {% for a in avisos %}
        {% set fotos_small = [] %}
        {% for f in a.fotos %}{% if '_320x240' in f.ruta_archivo %}{% set _ = fotos_small.append(f) %}{% endif %}{% endfor %}
        <tr class="fila-ult" data-href="{{ url_for('main.detalle', aviso_id=a.id) }}" style="cursor:pointer;">
          <td>{{ a.fecha_ingreso.strftime('%Y-%m-%d %H:%M') if a.fecha_ingreso else '' }}</td>
          <td>{{ a.comuna.nombre if a.comuna else '' }}</td>
          <td>{{ a.sector or '' }}</td>
          <td>
            {{ plural(a.cantidad, a.tipo, a.tipo + 's') }} — {{ plural(a.edad, 'mes', 'meses') if a.unidad_medida=='m' else plural(a.edad, 'año','años') }}
          </td>
          <td>
            {% if fotos_small %}
              {# mostramos solo la primera small; al click agrandamos su versión large #}
              {% set fsmall = fotos_small[0] %}
              {% set large = fsmall.ruta_archivo.replace('_320x240','_800x600') %}
              <img class="thumb" src="{{ url_for('static', filename='uploads/' ~ fsmall.ruta_archivo) }}" data-large="{{ url_for('static', filename='uploads/' ~ large) }}" alt="Foto de {{ a.tipo }}" style="max-width:70px; max-height:70px; object-fit:cover; cursor:zoom-in;">
            {% else %}-{% endif %}
          </td>
          {# Celda de acción eliminada #}
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>No hay avisos todavía. <a href="{{ url_for('main.agregar') }}">Agrega el primero</a>.</p>
    {% endif %}
  </section>

  <!-- Sección placeholder removida: ahora existe /estadisticas dedicada -->

  <p>
    <a href="https://jigsaw.w3.org/css-validator/check/referer">
      <img style="border:0;width:88px;height:31px" src="https://jigsaw.w3.org/css-validator/images/vcss" alt="¡CSS Válido!">
    </a>
  </p>
  <!-- Modal para ampliar imagen en portada -->
  <div id="modal-index" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); align-items:center; justify-content:center;">
    <div style="position:relative; max-width:90%; max-height:90%;">
      <button id="cerrar-modal-index" style="position:absolute; top:-10px; right:-10px; background:#fff; border:1px solid #333; cursor:pointer;">✕</button>
      <img 
        id="modal-index-img" 
        src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
        alt="Imagen grande" 
        style="max-width:100%; height:auto; display:block; border-radius:4px;">
    </div>
  </div>
</main>
<footer>
  <small>Aplicación educativa — Validar con W3C.</small>
</footer>

<script>
  document.addEventListener('DOMContentLoaded', ()=>{
    const PLACEHOLDER = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";

    const flash = document.getElementById('flash-overlay');
    if (flash){
      setTimeout(()=>{
        flash.style.transition='opacity .6s';
        flash.style.opacity='0';
        setTimeout(()=> flash.remove(), 700);
      }, 3500);
    }
    // Filas clickeables excepto cuando se hace click en la miniatura o en enlaces internos
    document.querySelectorAll('tr.fila-ult').forEach(tr=>{
      tr.addEventListener('click', (e)=>{
        const tag = e.target.tagName.toLowerCase();
        if (tag === 'img' || tag === 'a') return; // ignorar, ya manejado por otros listeners
        window.location = tr.dataset.href;
      });
    });

    // Modal para miniaturas
    const modal = document.getElementById('modal-index');
    const modalImg = document.getElementById('modal-index-img');
    const cerrar = document.getElementById('cerrar-modal-index');

    function abrir(src){ 
      modalImg.src = src || PLACEHOLDER;
      modal.style.display='flex'; 
    }
    function cerrarModal(){ 
      modal.style.display='none'; 
      modalImg.src=PLACEHOLDER; // nunca vacío (evita error W3C)
    }

    cerrar.addEventListener('click', cerrarModal);
    modal.addEventListener('click', (e)=>{ if (e.target === modal) cerrarModal(); });
    
    document.querySelectorAll('img.thumb').forEach(img=>{
      img.addEventListener('click', (e)=>{
        e.stopPropagation();
        abrir(img.dataset.large || img.src);
      });
    });
  });
</script>
</body>
</html>
